import asyncio
import json
import logging
import xui.public
from .states import AdminStates
from datetime import datetime
from aiogram import Bot, Router
from datetime import datetime, timedelta
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from config import config
from database.database import Session
from database.user import User, UserType, create_user, get_all_users, get_user, get_user_by_username

logger = logging.getLogger(__name__)
router = Router()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
@router.callback_query(F.data == "admin_send_message")
async def admin_send_message_start(callback: CallbackQuery, state: FSMContext):
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –° –ø–æ–¥–ø–∏—Å–∫–æ–π", callback_data="admin:send_message:active")
    builder.button(text="üõë –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏", callback_data="admin:send_message:inactive")
    builder.button(text="üë• –û–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é", callback_data="admin:send_personal_newsletter")
    builder.button(text="üë• –í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º", callback_data="admin:send_message:all")
    builder.button(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_menu")
    builder.adjust(1)
    
    await callback.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:",
        reply_markup=builder.as_markup()
    )

@router.callback_query(F.data.startswith("admin:send_message:"))
async def admin_send_message_target(callback: CallbackQuery, state: FSMContext):
    await callback.answer()  # –°–Ω–∏–º–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    target = callback.data.split(":")[2]
    await state.update_data(target=target)
    await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:")
    await state.set_state(AdminStates.SEND_MESSAGE)

@router.callback_query(lambda c: c.data == "admin:send_personal_newsletter")
async def ask_username(callback: CallbackQuery, state: FSMContext):
    await callback.message.answer("–í–≤–µ–¥–∏ —é–∑–µ—Ä–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É:")
    await state.set_state(AdminStates.send_message_waiting_username)
    await callback.answer()

@router.message(StateFilter(AdminStates.send_message_waiting_username))
async def ask_message_text(msg: Message, state: FSMContext):
    await state.update_data(username=msg.text.strip())
    await state.update_data(target="single")
    await msg.answer("–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏:")
    await state.set_state(AdminStates.send_message_waiting_text)

@router.message(StateFilter(AdminStates.send_message_waiting_text))
async def send_newsletter_now(msg: Message, state: FSMContext, bot: Bot):
    data = await state.get_data()
    username = data['username']
    target = data['target']
    text = msg.text.strip()

    users = []
    if target == "active":
        users = await get_all_users(with_subscription=True)
    elif target == "inactive":
        users = await get_all_users(with_subscription=False)
    elif target == "single":
        user = await get_user_by_username(username)
        if user:
            users.append(user)
        else:
            await msg.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª –±–æ—Ç–∞.")
            await state.clear()
            return
    else:
        users = await get_all_users()
    
    success = 0
    failed = 0
    
    for user in users:
        try:
            await bot.send_message(user.telegram_id, text)
            success += 1
        except Exception as e:
            logger.error(f"üõë –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è {user.telegram_id}: {e}")
            failed += 1
    
    await msg.answer(
        f"üì® –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—Å—ã–ª–∫–∏:\n\n"
        f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ: {success}\n"
        f"‚Ä¢ –ù–µ —É–¥–∞–ª–æ—Å—å: {failed}\n"
        f"‚Ä¢ –í—Å–µ–≥–æ: {len(users)}"
    )
    await state.clear()
